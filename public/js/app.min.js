/*! GAPP-Mapping-Application - v0.0.1 - 2013-09-19
* Copyright (c) 2013 ; Licensed  */
"use strict";function MapCtrl(a,b,c){a.goAdd=function(){c.path("/add1")},a.goAbout=function(){c.path("/about")},a.downloadData=function(){location.href="download/data.csv",c.path("/"),$("#map").removeClass("cross")},map.on("contextmenu",function(){}),a.allGardens,a.sendToGarden=function(b,d){map.panTo(b.target._latlng),map.setView(b.target._latlng,15),a.$apply(function(){c.path("/garden/"+d)})},a.getMarkers=function(){$.getJSON("/api/place",function(b){a.allGardens=b.data,$.each(b.data,function(b,c){if(void 0!=c.loc[0]){var d,e=0;switch(e+=c.habitat?1:0,e+=c.foodSource?1:0,e+=c.noPesticides?1:0){case 0:d=g0Icon;break;case 1:d=g1Icon;break;case 2:d=g2Icon;break;case 3:d=g3Icon}var f=c.loc,g=new L.LatLng(parseFloat(f[0]),parseFloat(f[1]));allMarkers.push(L.marker(g,{icon:d}).on("click",function(b){a.sendToGarden(b,c._id)}).addTo(map))}})})},a.getMarkers()}function AboutCtrl(a,b,c){$("#aboutModal").modal("show"),$("#aboutModal").on("hide.bs.modal",function(){c.path("/"),a.$apply()})}function AppCtrl(a,b){b({method:"GET",url:"/api/name"}).success(function(b){a.name=b.name}).error(function(){a.name="Error!"})}function PlaceCtrl(a,b,c,d){a.needABetterBrowser=!1;var e=navigator.userAgent.match(/(msie) (\d+)/i);null!==e&&(console.log(e),e[e.length-1]<9&&(a.needABetterBrowser=!0)),a.loc=addLatlng;var f=c.path();"/add1"===f&&($(".collapse").collapse("hide"),$("#add1Modal").modal("show"),$("#add1Modal").on("hide.bs.modal",function(){map.addEventListener("click",function(b){addLatlng=[b.latlng.lat,b.latlng.lng],c.path("/add2"),a.$apply()}),$("#map").addClass("cross")})),"/add2"===f&&(map.removeEventListener("click"),$("#map").removeClass("cross"),$("#add2Modal").modal("show"),$("#add2Modal").on("hidden.bs.modal",function(){c.path("/"),a.$apply()})),a.type="Private Citizen",a.where="Private Residence",a.uploadComplete=function(b,c){console.log(b,c),c&&($("#add2Modal").modal("hide"),d(a.getMarkers,500))}}function GardenCtrl(a,b,c,d,e){$("#gardenModal").modal("show"),$("#gardenModal").on("hide.bs.modal",function(){c.path("/"),a.$apply()}),a.id=e.id,a.fbUrl="https://www.facebook.com/sharer/sharer.php?u="+c.absUrl(),a.getClass=function(a){return a?"glyphicon glyphicon-check":"glyphicon glyphicon-unchecked"},a.thisGarden=_.findWhere(a.allGardens,{_id:a.id}),a.imageUrl="",null!=a.thisGarden.image&&(a.imageUrl="https://s3.amazonaws.com/gapp-map/"+a.thisGarden.image)}angular.module("ngUpload",[]).directive("uploadSubmit",["$parse",function(a){function b(a,c){a=angular.element(a);var d=a.parent();return c=c.toLowerCase(),d&&d[0].tagName.toLowerCase()===c?d:d?b(d,c):null}return{restrict:"AC",link:function(c,d,e){var f={};f.enableControls=e.uploadOptionsEnableControls,e.hasOwnProperty("uploadOptionsConvertHidden")&&(f.convertHidden="false"!=e.uploadOptionsConvertHidden);var g=b(d,"form"),h=a(e.uploadSubmit);if(!angular.isFunction(h)){var i="The expression on the ngUpload directive does not point to a valid function.";throw i+"\n"}d.bind("click",function(a){if(a&&(a.preventDefault=!0),!d.attr("disabled")){var b=angular.element("<iframe id='upload_iframe' name='upload_iframe' border='0' width='0' height='0' style='width: 0px; height: 0px; border: none; display: none' />");g.parent().append(b),b.bind("load",function(){var a=b[0],e=a.contentDocument||a.contentWindow.document,f=e.body.innerHTML;try{f=JSON.parse(f)}catch(g){console&&console.log("WARN: XHR response is not valid json")}c.$$phase?h(c,{content:f,completed:!0}):c.$apply(function(){h(c,{content:f,completed:!0})}),""!==f&&setTimeout(function(){b.remove()},250),d.attr("disabled",null),d.attr("title","Click to start upload.")}),c.$$phase?h(c,{content:"Please wait...",completed:!1}):c.$apply(function(){h(c,{content:"Please wait...",completed:!1})});var e=!0;f.enableControls||(d.attr("disabled","disabled"),e=!1),d.attr("title",(e?"[ENABLED]: ":"[DISABLED]: ")+"Uploading, please wait..."),f.convertHidden&&angular.forEach(g.find("input"),function(a){a=angular.element(a),a.attr("ng-model")&&a.attr("type")&&"hidden"==a.attr("type")&&a.attr("value",c.$eval(a.attr("ng-model")))}),g[0].submit()}}).attr("title","Click to start upload.")}}}]).directive("ngUpload",["$parse","$document",function(a,b){function c(a){var c,d=b.find("head");return angular.forEach(d.find("meta"),function(b){b.getAttribute("name")===a&&(c=b)}),angular.element(c)}return{restrict:"AC",link:function(a,b,d){var e={};d.hasOwnProperty("uploadOptionsEnableRailsCsrf")&&(e.enableRailsCsrf="false"!=d.uploadOptionsEnableRailsCsrf),b.attr("target","upload_iframe"),b.attr("method","post");var f=-1==b.attr("action").indexOf("?")?"?":"&";if(b.attr("action",b.attr("action")+f+"_t="+(new Date).getTime()),b.attr("enctype","multipart/form-data"),b.attr("encoding","multipart/form-data"),e.enableRailsCsrf){var g=angular.element("<input />");g.attr("class","upload-csrf-token"),g.attr("type","hidden"),g.attr("name",c("csrf-param").attr("content")),g.val(c("csrf-token").attr("content")),b.append(g)}}}}]),angular.module("myApp",["myApp.filters","myApp.services","myApp.directives","ngUpload"]).config(["$routeProvider",function(a){a.when("/add1",{templateUrl:"page/add1",controller:PlaceCtrl}),a.when("/add2",{templateUrl:"page/add2",controller:PlaceCtrl}),a.when("/about",{templateUrl:"page/about",controller:AboutCtrl}),a.when("/garden/:id",{templateUrl:"page/garden",controller:GardenCtrl}),a.otherwise({redirectTo:"/"})}]),angular.module("myApp.services",[]).value("version","0.1"),MapCtrl.$inject=["$scope","$http","$location"],AboutCtrl.$inject=["$scope","$http","$location"],AppCtrl.$inject=["$scope","$http"],PlaceCtrl.$inject=["$scope","$http","$location","$timeout"],GardenCtrl.$inject=["$scope","$http","$location","$route","$routeParams"],angular.module("myApp.filters",[]).filter("interpolate",["version",function(a){return function(b){return String(b).replace(/\%VERSION\%/gm,a)}}]),angular.module("myApp.directives",[]).directive("appVersion",["version",function(a){return function(b,c){c.text(a)}}]),L.Control.Locate=L.Control.extend({options:{position:"topleft",drawCircle:!0,follow:!1,stopFollowingOnDrag:!1,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:4},followCircleStyle:{},followMarkerStyle:{},metric:!0,debug:!1,onLocationError:function(a){alert(a.message)},setView:!0,strings:{title:"Show me where I am",popup:"You are within {distance} {unit} from this point"},locateOptions:{}},onAdd:function(a){var b="leaflet-control-locate",c=b+" leaflet-control-zoom leaflet-bar leaflet-control",d=L.DomUtil.create("div",c),e=this;this._layer=new L.LayerGroup,this._layer.addTo(a),this._event=void 0,this._locateOptions=L.extend(L.extend({setView:!1},this.options.locateOptions),{watch:!0});var f={};L.extend(f,this.options.markerStyle,this.options.followMarkerStyle),this.options.followMarkerStyle=f,f={},L.extend(f,this.options.circleStyle,this.options.followCircleStyle),this.options.followCircleStyle=f;var g=L.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",d);g.href="#",g.title=this.options.strings.title;var h=function(a){e.options.debug&&console.log(a)};L.DomEvent.on(g,"click",L.DomEvent.stopPropagation).on(g,"click",L.DomEvent.preventDefault).on(g,"click",function(){!e._active||!a.getBounds().contains(e._event.latlng)&&e.options.setView?(e.options.setView&&(e._locateOnNextLocationFound=!0),e._active||a.locate(e._locateOptions),e._active=!0,e.options.follow&&j(),e._event?l():e._container.className=c+" requesting"):n()}).on(g,"dblclick",L.DomEvent.stopPropagation);var i=function(a){h("onLocationFound"),e._active=!0,!e._event||e._event.latlng.lat==a.latlng.lat&&e._event.latlng.lng==a.latlng.lng||h("location has changed"),e._event=a,e.options.follow&&e._following&&(e._locateOnNextLocationFound=!0),l()},j=function(){e._following=!0,e.options.stopFollowingOnDrag&&a.on("dragstart",k)},k=function(){e._following=!1,e.options.stopFollowingOnDrag&&a.off("dragstart",k),l()},l=function(){h("visualizeLocation,setView:"+e._locateOnNextLocationFound);var b=e._event.accuracy/2;e._locateOnNextLocationFound&&(a.fitBounds(e._event.bounds),e._locateOnNextLocationFound=!1),e._layer.clearLayers();var d;e.options.drawCircle&&(d=e._following?e.options.followCircleStyle:e.options.circleStyle,L.circle(e._event.latlng,b,d).addTo(e._layer));var f,g;e.options.metric?(f=b.toFixed(0),g="meters"):(f=(3.2808399*b).toFixed(0),g="feet");var i;i=e._following?e.options.followMarkerStyle:e.options.markerStyle;var j=e.options.strings.popup;L.circleMarker(e._event.latlng,i).bindPopup(L.Util.template(j,{distance:f,unit:g})).addTo(e._layer),e._container&&(e._container.className=e._following?c+" active following":c+" active")},m=function(){e._active=!1,e._locateOnNextLocationFound=!0,e._following=!1};m();var n=function(){h("stopLocate"),a.stopLocate(),a.off("dragstart",k),e._container.className=c,m(),e._layer.clearLayers()},o=function(a){h("onLocationError"),3==a.code&&this._locateOptions.watch||(n(),e.options.onLocationError(a))};return a.on("locationfound",i,e),a.on("locationerror",o,e),d}}),L.Map.addInitHook(function(){this.options.locateControl&&(this.locateControl=L.control.locate(),this.addControl(this.locateControl))}),L.control.locate=function(a){return new L.Control.Locate(a)};var map,allMarkers=[],addLatlng=[],gsuLocation=[33.75317514689363,-84.38607215881348];map=L.map("map").setView(gsuLocation,11),L.control.locate().addTo(map),L.esri.basemapLayer("Topographic").addTo(map);var g0Icon=L.icon({iconUrl:"images/g0.png",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[-3,-76]}),g1Icon=L.icon({iconUrl:"images/g1.png",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[-3,-76]}),g2Icon=L.icon({iconUrl:"images/g2.png",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[-3,-76]}),g3Icon=L.icon({iconUrl:"images/g3.png",iconSize:[24,24],iconAnchor:[0,0],popupAnchor:[-3,-76]});